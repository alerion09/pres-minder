# Database Schema for PresMinder MVP

## 1. Tables

### 1.1 users - Managed by Supabase Auth.

| Column             | Type         | Constraints            | Description   |
| ------------------ | ------------ | ---------------------- | ------------- |
| id                 | UUID         | PRIMARY KEY            | Primary key   |
| email              | VARCHAR(255) | NOT NULL, UNIQUE       | User email    |
| encrypted_password | VARCHAR      | NOT NULL               | User password |
| created_at         | TIMESTAMPZ   | NOT NULL DEFAULT now() | Created at    |
| confirmed_at       | TIMESTAMPZ   | -                      | Confirmed at  |

### 1.1. relations (Dictionary Table)

Predefined types of relationships between the user and the gift recipient.

| Column | Type      | Constraints      | Description                                                |
| ------ | --------- | ---------------- | ---------------------------------------------------------- |
| id     | BIGSERIAL | PRIMARY KEY      | Primary key                                                |
| name   | TEXT      | NOT NULL, UNIQUE | Name of the relation (e.g., "friend", "parent", "sibling") |

### 1.2. occasions (Dictionary Table)

Predefined occasions for giving a gift.

| Column | Type      | Constraints      | Description                                                       |
| ------ | --------- | ---------------- | ----------------------------------------------------------------- |
| id     | BIGSERIAL | PRIMARY KEY      | Primary key                                                       |
| name   | TEXT      | NOT NULL, UNIQUE | Name of the occasion (e.g., "birthday", "anniversary", "wedding") |

### 1.3. ideas (Main Table)

Main table for storing gift ideas.

| Column             | Type        | Constraints                                                                  | Description                               |
| ------------------ | ----------- | ---------------------------------------------------------------------------- | ----------------------------------------- |
| id                 | BIGSERIAL   | PRIMARY KEY, DEFAULT gen_random_uuid()                                       | Primary key                               |
| user_id            | UUID        | NOT NULL, FOREIGN KEY REFERENCES auth.users(id) ON DELETE CASCADE            | Owner of the idea                         |
| name               | TEXT        | NOT NULL, CHECK (length(name) > 1)                                           | Name of the idea (minimum 2 characters)   |
| content            | TEXT        | NOT NULL                                                                     | Main content of the gift idea             |
| age                | INTEGER     | CHECK (age > 0 AND age <= 500)                                               | Age of the gift recipient                 |
| interests          | TEXT        | NULL                                                                         | Interests of the person                   |
| person_description | TEXT        | NULL                                                                         | Additional description of the person      |
| budget_min         | NUMERIC     | CHECK (budget_min >= 0)                                                      | Lower budget limit                        |
| budget_max         | NUMERIC     | CHECK (budget_max >= 0 AND (budget_min IS NULL OR budget_max >= budget_min)) | Upper budget limit                        |
| relation_id        | BIGINT      | NULL, FOREIGN KEY REFERENCES relations(id) ON DELETE SET NULL                | Relation with the gift recipient          |
| occasion_id        | BIGINT      | NULL, FOREIGN KEY REFERENCES occasions(id) ON DELETE SET NULL                | Occasion for the gift                     |
| source             | idea_source | NOT NULL, DEFAULT 'manual'                                                   | Source of the idea: manual, ai, edited-ai |
| created_at         | TIMESTAMPTZ | NOT NULL, DEFAULT NOW()                                                      | Creation date and time                    |
| updated_at         | TIMESTAMPTZ | NOT NULL, DEFAULT NOW()                                                      | Last modification date and time           |

## 2. Custom Types

### 2.1. idea_source (ENUM)

Enum type specifying the origin of the idea.

```
sql
CREATE TYPE idea_source AS ENUM ('manual', 'ai', 'edited-ai');
```

**Values:**

- `manual` - idea created manually by the user
- `ai` - idea generated by AI and accepted without modification
- `edited-ai` - idea generated by AI and subsequently edited by the user

## 3. Relationships

### 3.1. Users → Ideas (One-to-Many)

- `auth.users.id` → `ideas.user_id`
- One user can have many ideas
- Cascade delete: deleting a user deletes all their ideas

### 3.2. Relations → Ideas (One-to-Many)

- `relations.id` → `ideas.relation_id`
- One relation can be used in many ideas
- SET NULL on delete: deleting a relation does not delete ideas, but sets the field to NULL

### 3.3. Occasions → Ideas (One-to-Many)

- `occasions.id` → `ideas.occasion_id`
- One occasion can be used in many ideas
- SET NULL on delete: deleting an occasion does not delete ideas, but sets the field to NULL

## 4. Indexes

### 4.1. Primary Indexes

- `relations_pkey` ON relations(id)
- `occasions_pkey` ON occasions(id)
- `ideas_pkey` ON ideas(id)

### 4.2. Performance Indexes

```
sql
-- Optimizes queries for a user's list of ideas sorted chronologically
CREATE INDEX idx_ideas_user_created ON ideas(user_id, created_at DESC);

-- Optimizes searches by relation
CREATE INDEX idx_ideas_relation ON ideas(relation_id) WHERE relation_id IS NOT NULL;

-- Optimizes searches by occasion
CREATE INDEX idx_ideas_occasion ON ideas(occasion_id) WHERE occasion_id IS NOT NULL;

-- Optimizes filtering by source
CREATE INDEX idx_ideas_source ON ideas(source);
```

## 5. Row Level Security (RLS) Policies

### 5.1. ideas table policies

**Enable RLS:**

```
sql
ALTER TABLE ideas ENABLE ROW LEVEL SECURITY;
```

**Policy: Users can view only their own ideas**

```
sql
CREATE POLICY "Users can view their own ideas"
ON ideas
FOR SELECT
USING (auth.uid() = user_id);
```

**Policy: Users can insert their own ideas**

```
sql
CREATE POLICY "Users can insert their own ideas"
ON ideas
FOR INSERT
WITH CHECK (auth.uid() = user_id);
```

**Policy: Users can update only their own ideas**

```
sql
CREATE POLICY "Users can update their own ideas"
ON ideas
FOR UPDATE
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);
```

**Policy: Users can delete only their own ideas**

```
sql
CREATE POLICY "Users can delete their own ideas"
ON ideas
FOR DELETE
USING (auth.uid() = user_id);
```

### 5.2. relations and occasions tables policies

**Enable RLS:**

```
sql
ALTER TABLE relations ENABLE ROW LEVEL SECURITY;
ALTER TABLE occasions ENABLE ROW LEVEL SECURITY;
```

**Policy: All authenticated users can read dictionary tables**

```
sql
CREATE POLICY "Authenticated users can view relations"
ON relations
FOR SELECT
TO authenticated
USING (true);

CREATE POLICY "Authenticated users can view occasions"
ON occasions
FOR SELECT
TO authenticated
USING (true);
```

## 6. Triggers

### 6.1. Auto-update updated_at timestamp

```
sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
NEW.updated_at = NOW();
RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_ideas_updated_at
BEFORE UPDATE ON ideas
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

## 7. Initial Data

### 7.1. Sample Relations

```
sql
INSERT INTO relations (name) VALUES
('friend'),
('parent'),
('sibling'),
('partner'),
('colleague'),
('child'),
('grandparent'),
('other');
```

### 7.2. Sample Occasions

```
sql
INSERT INTO occasions (name) VALUES
('birthday'),
('anniversary'),
('wedding'),
('christmas'),
('valentines_day'),
('graduation'),
('baby_shower'),
('housewarming'),
('other');
```

## 8. Design Notes

### 8.1. Budget Implementation

The budget is implemented as two separate numeric fields (`budget_min`, `budget_max`) instead of a predefined list to ensure maximum flexibility. Users can specify an exact price range.

### 8.2. ON DELETE Strategies

- **user_id**: CASCADE - deleting a user must delete all their data
- **relation_id, occasion_id**: SET NULL - deleting a dictionary category should not delete ideas

### 8.3. Source Field Logic

According to the business requirements from the PRD:

- An idea generated by AI, even after editing, retains the 'ai' flag
- The flag changes to 'manual' only if the user deletes the entire content and writes a new one from scratch
- This logic will be implemented at the application level, not at the database level

### 8.4. Performance Considerations

The composite index `(user_id, created_at DESC)` was created because:

- The most frequent query will be fetching a user's list of ideas sorted chronologically
- This allows for the effective use of index-only scans in PostgreSQL
- It supports result pagination

### 8.5. Validation Constraints

All key validations have been implemented at the database level:

- `name`: minimum 2 characters (CHECK length > 1)
- `age`: range 1-500 years (CHECK constraint)
- `budget_max`: must be >= `budget_min` if both fields are filled
- All budget values must be non-negative

### 8.6. Scalability

The schema was designed with scalability in mind:

- Appropriate indexes for the most common operations
- RLS policies provide row-level security
- Normalization to 3NF (dictionaries extracted)
- Automatic timestamps for change auditing

### 8.7. Supabase Integration

The schema is fully compatible with Supabase:

- It uses `auth.users` as the source of users
- RLS policies use `auth.uid()` for user identification
- All CRUD operations are secured by RLS
- No need to create an additional 'profiles' table

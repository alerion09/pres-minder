---
import AppLayout from "@/layouts/AppLayout.astro";
import { IdeasView } from "@/components/ideas/IdeasView";
import type { GetIdeasQueryParams, IdeaSource } from "@/types";
import { getIdeasForUser } from "@/lib/services/ideas/get-ideas.service";

export const prerender = false;

// Get authenticated user from middleware
const user = Astro.locals.user;
if (!user) {
  return Astro.redirect("/login");
}

// Parse query parameters
const url = Astro.url;

const page = parseInt(url.searchParams.get("page") || "1");
const limit = parseInt(url.searchParams.get("limit") || "6");
const sort = (url.searchParams.get("sort") as GetIdeasQueryParams["sort"]) || "created_at";
const order = (url.searchParams.get("order") as GetIdeasQueryParams["order"]) || "desc";
const relationIdParam = url.searchParams.get("relation_id");
const occasionIdParam = url.searchParams.get("occasion_id");
const sourceParam = url.searchParams.get("source");

const relationId = relationIdParam ? parseInt(relationIdParam) : undefined;
const occasionId = occasionIdParam ? parseInt(occasionIdParam) : undefined;
const source = sourceParam ? (sourceParam as IdeaSource) : undefined;

// Get Supabase client from middleware
const supabase = Astro.locals.supabase;

// Fetch relations, occasions, and ideas directly from database
const [relationsRes, occasionsRes] = await Promise.all([
  supabase.from("relations").select("*").order("name", { ascending: true }),
  supabase.from("occasions").select("*").order("name", { ascending: true }),
]);

// Handle database errors
if (relationsRes.error || occasionsRes.error) {
  console.error("[index.astro] Database error:", {
    relationsError: relationsRes.error,
    occasionsError: occasionsRes.error,
  });
  throw new Error("Failed to fetch data");
}

const relations = relationsRes.data || [];
const occasions = occasionsRes.data || [];

// Fetch ideas using service - only for authenticated user
const ideasData = await getIdeasForUser(supabase, user.id, {
  page,
  limit,
  sort,
  order,
  relation_id: relationId,
  occasion_id: occasionId,
  source,
});

// Prepare initial state for client
const initialState = {
  ideas: ideasData.data || [],
  pagination: ideasData.pagination,
  relations,
  occasions,
  filters: {
    page,
    limit,
    sort,
    order,
    relationId,
    occasionId,
    source,
  },
};
---

<AppLayout title="Moje pomysÅ‚y">
  <IdeasView
    client:load
    userId={user.id}
    initialIdeas={initialState.ideas}
    initialPagination={initialState.pagination}
    initialFilters={initialState.filters}
    relations={initialState.relations}
    occasions={initialState.occasions}
  />
</AppLayout>
